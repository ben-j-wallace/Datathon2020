---
title: "Model"
author: "Ben Wallace, Lily Zhu"
date: "10/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(here)
library(broom)
library(knitr)
library(data.table)
library(patchwork)
```

```{r read data}
unemployment_change <- fread(here("data", "unemployment-change.csv"))
mobility_avg <- fread(here("data", "mobility-avg.csv")) %>%
  mutate(county = sub_region_2) %>%
  select(-sub_region_2)
socioeconomic <- fread(here("data", "socioeconomic.csv")) %>%
  mutate(county = area_name) %>%
  select(-area_name)
```

## Merge data

```{r}
merged_data <- unemployment_change %>%
  inner_join(mobility_avg, by = "county") %>%
  inner_join(socioeconomic, by = "county") %>%
  select(-parks_avg, -transit_avg) %>%
  na.omit

set.seed(0)
sample_data <- sample_n(merged_data, 500)
```

## Univariate analysis

```{r}
ggplot(data = sample_data, mapping = aes(x = unemployment_change)) +
  geom_histogram()
```

```{r}
ggplot(data = sample_data, mapping = aes(x = retail_avg)) +
  geom_histogram()
```

```{r}
ggplot(data = sample_data, mapping = aes(x = grocery_avg)) +
  geom_histogram()
```

```{r}
ggplot(data = sample_data, mapping = aes(x = workplaces_avg)) +
  geom_histogram()
```

```{r}
ggplot(data = sample_data, mapping = aes(x = residential_avg)) +
  geom_histogram()
```

```{r}
merged_data %>% 
  summarise(mean = mean(unemployment_change),
          median = median(unemployment_change),
          sd = sd(unemployment_change),
          iqr = IQR(unemployment_change),
          min = min(unemployment_change),
          max = max(unemployment_change))
```

```{r}
merged_data %>% 
  filter(!is.na(retail_avg)) %>% 
  summarise(mean = mean(retail_avg),
          median = median(retail_avg),
          sd = sd(retail_avg),
          iqr = IQR(retail_avg),
          min = min(retail_avg),
          max = max(retail_avg))
```

```{r}
merged_data %>% 
  filter(!is.na(grocery_avg)) %>% 
  summarise(mean = mean(grocery_avg),
          median = median(grocery_avg),
          sd = sd(grocery_avg),
          iqr = IQR(grocery_avg),
          min = min(grocery_avg),
          max = max(grocery_avg))
```

```{r}
merged_data %>% 
  filter(!is.na(workplaces_avg)) %>%
  summarise(mean = mean(workplaces_avg),
          median = median(workplaces_avg),
          sd = sd(workplaces_avg),
          iqr = IQR(workplaces_avg),
          min = min(workplaces_avg),
          max = max(workplaces_avg))
```

```{r}
merged_data %>% 
  filter(!is.na(residential_avg)) %>%
  summarise(mean = mean(residential_avg),
          median = median(residential_avg),
          sd = sd(residential_avg),
          iqr = IQR(residential_avg),
          min = min(residential_avg),
          max = max(residential_avg))
```

## Bivariate analysis

```{r}
sample_data %>%
  ggplot(aes(y = unemployment_change, x = retail_avg)) +
  geom_point()
```

```{r}
merged_data %>%
  ggplot(aes(y = unemployment_change, x = grocery_avg)) +
  geom_point()
```

```{r}
merged_data %>%
  ggplot(aes(y = unemployment_change, x = workplaces_avg)) +
  geom_point()
```

```{r}
merged_data %>%
  ggplot(aes(y = unemployment_change, x = residential_avg)) +
  geom_point()
```

## Model

```{r}
model <- lm(unemployment_change ~ retail_avg + 
              grocery_avg + 
              workplaces_avg + 
              residential_avg, 
            data = merged_data)
```

```{r backward selection}
int_only_model <- lm(unemployment_change ~ 1, data = merged_data)

final_model <- step(model, scope = formula(int_only_model), direction = "backward")

final_model %>%
  tidy(conf.int = TRUE) %>%
  kable(digits = 3)
```

```{r}
model_aug <- augment(final_model) 

model_aug %>%
  ggplot(aes(x = .fitted, y = .resid)) +
  geom_point() +
  theme_grey(base_size = 14) +
  labs(x = "Fitted", y = "Residual", title = "Residuals Show No Pattern")
```

```{r cooks distance}
ggplot(model_aug, aes(x = obs_num, y = .cooksd)) +
  geom_point(alpha = 0.7) +
  geom_hline(yintercept = c(0.5, 1), color = "red") +
  labs(x = "Observation Number", y= "Cook's D") +
  geom_text(aes(label=ifelse(.hat > 0.5,
  as.character(obs_num), "")), nudge_x = 1)
```

```{r conditions}
resid_fitted <- ggplot(data = model_aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red") +
  labs(x = "Predicted values",
    y = "Residual",
    title = "Residuals vs. Predicted")

resid_hist <- ggplot(data = model_aug, aes(x = .resid)) +
  geom_histogram() +
  labs(x = "Residuals", title = "Dist. of Residuals")

resid_qq <- ggplot(data = model_aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Normal QQ-plot of residuals")

resid_fitted / (resid_hist + resid_qq)
```


## Questions
- What is the relationship between ___ and ___? What does this say about the future of unemployment during the future of this pandemic, which experts believe will continue into the next years?
- Given the relationship between these variables, what is the expected unemployment rate of North Carolina counties?

## Predictors:
- resilience:

## Response:
- unemployment rate:

## EDA:

See .rmd files in folder.

## Model: We will use a multiple linear regression model with the following form:

> unemployment rate = resilience + __ + __ + __ + __

#### Output:



